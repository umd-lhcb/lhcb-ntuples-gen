headers:
    system:
        - TVector3.h
        - TLorentzVector.h
    user:
        - functor/flag.h
        - functor/pid.h

keep:
    # Event uid
    - runNumber
    - eventNumber
    - GpsTime
    - EventInSequence

rename:
    # General
    Polarity: polarity
    # For pseudo-random sequence generation
    b0_PT: b_pt
    # NOTE: We decide to NOT differentiate between B0 and B- in step-2 variable names.
    # B0
    b0_L0Global_TIS: b_l0_tis
    b0_L0Global_TOS: b_l0_tos
    b0_DIRA_OWNPV: b_dira
    b0_ISOLATION_BDT: iso_bdt  # Isolation BDT
    b0_ENDVERTEX_CHI2: b_endvtx_chi2
    b0_ENDVERTEX_NDOF: b_endvtx_ndof
    b0_DISCARDMu_CHI2: b_discard_mu_chi2
    b0_M: b_m
    b0_PT: b_pt
    b0_PZ: b_pz
    # D*
    dst_M: dst_m
    dst_ENDVERTEX_CHI2: dst_endvtx_chi2
    dst_ENDVERTEX_NDOF: dst_endvtx_ndof
    dst_L0Global_TOS: dst_l0_tos
    dst_Hlt1Phys_TOS: dst_hlt1_tos
    # D0
    d0_Hlt2CharmHadD02HH_D02KPiDecision_TOS: d0_hlt2charmhad_tos
    d0_DIRA_OWNPV: d0_dira
    d0_M: d0_m
    d0_ID: d0_id
    d0_ENDVERTEX_CHI2: d0_endvtx_chi2
    d0_ENDVERTEX_NDOF: d0_endvtx_ndof
    d0_IP_OWNPV: d0_ip
    d0_IPCHI2_OWNPV: d0_ip_chi2
    d0_FDCHI2_OWNPV: d0_fd_chi2
    d0_L0HadronDecision_TOS: d0_l0had_tos
    d0_Hlt2CharmHadD02HH_D02KPiDecision_TOS: d0_hlt2charmhad_tos
    # Mu
    mu_isMuon: mu_is_mu
    mu_PIDmu: mu_pid_mu
    mu_PIDe: mu_pid_e
    mu_ID: mu_id
    mu_IPCHI2_OWNPV: mu_ip_chi2
    mu_TRACK_GhostProb: mu_gh_prob
    mu_L0Global_TIS: mu_l0_tis
    # K
    k_P: k_p
    k_PT: k_pt
    k_Hlt1Global_TOS: k_hlt1_tos
    k_Hlt1TrackAllL0Decision_TOS: k_hlt1ta_tos
    k_PIDK: k_pid_k
    k_IPCHI2_OWNPV: k_ip_chi2
    k_TRACK_GhostProb: k_gh_prob
    k_isMuon: k_is_mu
    # Pi
    pi_ID: pi_id
    pi_P: pi_p
    pi_PT: pi_pt
    pi_Hlt1Global_TOS: pi_hlt1_tos
    pi_Hlt1TrackAllL0Decision_TOS: pi_hlt1ta_tos
    pi_PIDK: pi_pid_k
    pi_IPCHI2_OWNPV: pi_ip_chi2
    pi_TRACK_GhostProb: pi_gh_prob
    pi_isMuon: pi_is_mu
    # Slow Pi
    spi_TRACK_GhostProb: spi_gh_prob
    spi_TRACK_Type: spi_trk_type

calculation:
    # PID
    dst_id_prod: Double_t; d0_id*pi_id
    id_prod: Double_t; d0_id*mu_id
    # Fit variables
    mm2: Double_t; GEV2(FitVar_Mmiss2)
    q2: Double_t; GEV2(FitVar_q2)
    el: Double_t; GEV(FitVar_El)
    # Other flags
    is_data: Bool_t; IS_DATA(GpsTime)
    # B0/B-
    v3_b_flight: >-
        ^auto; TVector3(
        Y_ENDVERTEX_X-Y_OWNPV_X,
        Y_ENDVERTEX_Y-Y_OWNPV_Y,
        Y_ENDVERTEX_Z-Y_OWNPV_Z
        )
    b_fd_trans: Double_t; v3_b_flight.Perp()

    mu_pid: Bool_t; MU_PID(mu_is_mu, mu_pid_mu)

one_cand_only:
    enable: true
    branch: b_pt

output:
    mc_dst_tau:
        input: TupleB0/DecayTree
        selection:
            - "dst_id_prod > 0"
            - "id_prod > 0"
            - "mu_pid > 0"
            # Trigger cuts
            - "b_l0_tis || d0_l0had_tos"
            - "d0_hlt2charmhad_tos"
            - "mu_l0_tis"
            - "dst_hlt1_tos"
            # Cuts on fit variables
            - "-2.0 <= mm2 <= 10.0"
            - "0.1 <= el <= 2.5"
            - "-0.4 <= q2 <= 12.6"
            # Selection flags
            - "flag_sel_b0dst"

    mc_dst_tau_aux:
        input: MCTupleB0Tau/MCDecayTree

    dst_iso:
        input: TupleY/DecayTree
        selection:
            - "mu_pid"
            - "iso_bdt < 0.15"
            - "is_data"
            - "b0_m < 5280"
            # L0 cuts
            - "b0_l0_tis || dst_l0had_tos"
            - "mu_l0_tis"
