It is harder to manage large (100 MB or more) files in `git`, as checking them
in/out would take a much longer time. Also, it is undesirable to expose raw
data outside of the collaboration.

We use a `git` addon, `git-annex`, to manage large files. `git-annex` stores all
tracked files under `<project_root>/.git/annex`, and link/copy these files to
the expected locations.


## Initialize `git-annex` repository
We have a private server[^1] that hosts `git` repositories with `git-annex`
capabilities.
After clone this repository from github, please also add our private repository:
```
git remote add julian git@129.2.92.92:lhcb-ntuples-gen
```

!!! note
    Please send us a SSH key so that we can give your read/write permission on
    the `git-annex` repository.

Then we need to initialize the `annex` component:
```
git annex init --version=7
```

!!! warning
    It is important to use a `git-annex` repository of `v7` or newer![^2]

    To upgrade your `git-annex` repository to at least `v7`, issue the
    following command inside your `git` repository:
    ```
    git annex upgrade
    ```

!!! note
    Dropbox will not synchronize any symbolic links, so if the repository is
    placed within your Dropbox folder, and you have multiple computers, the
    symbolic links will be replaced by the actual files on all but the initial
    computers.


[^1]: As of now, the server is sitting on Yipeng's desktop. It is named
      `Julian`, after [Julian Schwinger](https://en.wikipedia.org/wiki/Julian_Schwinger).
[^2]: Please read [this](https://git-annex.branchable.com/tips/unlocked_files/) for the rationale.


## Add files
If you are adding large files that are unlikely to change in the future, such
as `.dst` data files, use the following command:
```
git annex add <path_to_file>
```

If you want to add large files that are likely to change, such as `.root`
ntuples generated by `DaVinci`, use regular `git add` command:
```
git add <path_to_file>
```

!!! note
    `git add` will add files to the `git` repository, **not** `git-annex`
    repository **by default**. Configuration is required to add only `.root`
    files to `git-annex`, and the rest to `git`. This has been done for this
    repository, in:
    ```
    <project_root>/.gitattributes`
    ```

    See [this article](https://git-annex.branchable.com/tips/largefiles/)
    for more information on configuring `.gitattributes`.


## Change annexed files
Files added via `git annex add` are read only. For example:
```
echo change > <path_to_annexed_file>
> bash: <annexed_file>: Permission denied
```

To change them, we need to unlock them first:
```
git annex unlock <path_to_annexed_file>
```

Now you can edit the unlocked file as you wish. After editing, use `git commit`
to keep the changes.

If you don't need to modify the file after all, or want to discard
modifications, just use `git annex lock`.

!!! note
    When you commit, `git-annex` will notice that you are committing an
    unlocked file, add its new content.
    A pointer to that content is what gets committed to `git`; the actual
    content will go to `git-annex`.

Files added via `git add` can be changed just like a regular file.


## Synchronize files between local and remote repositories
The simplest, but potentially dangerous because it may cause merge conflicts,
method is:
```
git annex sync julian
```

A safer, **two-step** process is:
```
git annex sync --no-pull julian
git annex sync julian
```

!!! warning
    The two separate steps are needed to avoid unnecessary merge conflicts.

If you want to download **every single file** from the `git-annex` repo (which is
probably a couple of GBs), add the `--content` flag in the second step and
download not only the metadata, but also the data:
```
git annex sync --no-pull julian
git annex sync --content julian
```


## Download individual files
This is simple:
```
git annex get <path_to_files>
```


## Drop local files
The following command will remove the local copy of the file **only**, and will
not delete the file from remote[^3]:
```
git annex drop <path_to_files>
```

!!! note
    `git` would still think the working directory is clean, i.e. no change has
    been made.


[^3]: **Deleting files from remote is dangerous!** As the remote might be the
      last copy of the file so we may lose the file permanently.

      Still, if you insist, please refer to the [official guide](https://git-annex.branchable.com/tips/deleting_unwanted_files).
